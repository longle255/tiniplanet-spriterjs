
/*
 * -------------------------------------------------------
 * Project: tiNiPlanet SpriterJS
 * Version: 0.0.1
 *
 * Author:  longle255
 * Site:     
 * Contact: hoanglong25588@gmail.com
 *
 *
 * Copyright (c) 2014 longle255
 * -------------------------------------------------------
 */

"use strict";function xml2json(xml,tab){var X={toObj:function(xml){var o={};if(1==xml.nodeType){if(xml.attributes.length)for(var i=0;i<xml.attributes.length;i++)o["@"+xml.attributes[i].nodeName]=(xml.attributes[i].nodeValue||"").toString();if(xml.firstChild){for(var textChild=0,cdataChild=0,hasElementChild=!1,n=xml.firstChild;n;n=n.nextSibling)1==n.nodeType?hasElementChild=!0:3==n.nodeType&&n.nodeValue.match(/[^ \f\n\r\t\v]/)?textChild++:4==n.nodeType&&cdataChild++;if(hasElementChild)if(2>textChild&&2>cdataChild){X.removeWhite(xml);for(var n=xml.firstChild;n;n=n.nextSibling)3==n.nodeType?o["#text"]=X.escape(n.nodeValue):4==n.nodeType?o["#cdata"]=X.escape(n.nodeValue):o[n.nodeName]?o[n.nodeName]instanceof Array?o[n.nodeName][o[n.nodeName].length]=X.toObj(n):o[n.nodeName]=[o[n.nodeName],X.toObj(n)]:o[n.nodeName]=X.toObj(n)}else xml.attributes.length?o["#text"]=X.escape(X.innerXml(xml)):o=X.escape(X.innerXml(xml));else if(textChild)xml.attributes.length?o["#text"]=X.escape(X.innerXml(xml)):o=X.escape(X.innerXml(xml));else if(cdataChild)if(cdataChild>1)o=X.escape(X.innerXml(xml));else for(var n=xml.firstChild;n;n=n.nextSibling)o["#cdata"]=X.escape(n.nodeValue)}xml.attributes.length||xml.firstChild||(o=null)}else 9==xml.nodeType?o=X.toObj(xml.documentElement):alert("unhandled node type: "+xml.nodeType);return o},toJson:function(o,name,ind){var json=name?'"'+name+'"':"";if(o instanceof Array){for(var i=0,n=o.length;n>i;i++)o[i]=X.toJson(o[i],"",ind+"	");json+=(name?":[":"[")+(o.length>1?"\n"+ind+"	"+o.join(",\n"+ind+"	")+"\n"+ind:o.join(""))+"]"}else if(null==o)json+=(name&&":")+"null";else if("object"==typeof o){var arr=[];for(var m in o)arr[arr.length]=X.toJson(o[m],m,ind+"	");json+=(name?":{":"{")+(arr.length>1?"\n"+ind+"	"+arr.join(",\n"+ind+"	")+"\n"+ind:arr.join(""))+"}"}else json+="string"==typeof o?(name&&":")+'"'+o.toString()+'"':(name&&":")+o.toString();return json},innerXml:function(node){var s="";if("innerHTML"in node)s=node.innerHTML;else for(var asXml=function(n){var s="";if(1==n.nodeType){s+="<"+n.nodeName;for(var i=0;i<n.attributes.length;i++)s+=" "+n.attributes[i].nodeName+'="'+(n.attributes[i].nodeValue||"").toString()+'"';if(n.firstChild){s+=">";for(var c=n.firstChild;c;c=c.nextSibling)s+=asXml(c);s+="</"+n.nodeName+">"}else s+="/>"}else 3==n.nodeType?s+=n.nodeValue:4==n.nodeType&&(s+="<![CDATA["+n.nodeValue+"]]>");return s},c=node.firstChild;c;c=c.nextSibling)s+=asXml(c);return s},escape:function(txt){return txt.replace(/[\\]/g,"\\\\").replace(/[\"]/g,'\\"').replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r")},removeWhite:function(e){e.normalize();for(var n=e.firstChild;n;)if(3==n.nodeType)if(n.nodeValue.match(/[^ \f\n\r\t\v]/))n=n.nextSibling;else{var nxt=n.nextSibling;e.removeChild(n),n=nxt}else 1==n.nodeType?(X.removeWhite(n),n=n.nextSibling):n=n.nextSibling;return e}};9==xml.nodeType&&(xml=xml.documentElement);var json=X.toJson(X.toObj(X.removeWhite(xml)),xml.nodeName,"	");return"{\n"+tab+(tab?json.replace(/\t/g,tab):json.replace(/\t|\n/g,""))+"\n}"}var fo=fo||{};fo.v2=function(x,y){this.x=x||0,this.y=y||0},fo.v2.ZERO=new fo.v2,fo.v2.prototype.makeZero=function(){return this.x=0,this.y=0,this},fo.v2.prototype.selfTranslate=function(x,y){return this.x+=x,this.y+=y,this},fo.v2.prototype.selfRotate=function(c,s){var x=this.x,y=this.y;return this.x=x*c-y*s,this.y=x*s+y*c,this},fo.v2.prototype.selfRotateRadians=function(rad){return this.selfRotate(Math.cos(rad),Math.sin(rad))},fo.v2.prototype.selfRotateDegrees=function(deg){return this.selfRotateRadians(deg*Math.PI/180)},fo.v2.prototype.selfScale=function(x,y){return this.x*=x,this.y*=y,this},fo.m3x2=function(){this.a_x=1,this.b_x=0,this.c_x=0,this.a_y=0,this.b_y=1,this.c_y=0},fo.m3x2.IDENTITY=new fo.m3x2,fo.m3x2.prototype.makeIdentity=function(){return this.a_x=1,this.b_x=0,this.c_x=0,this.a_y=0,this.b_y=1,this.c_y=0,this},fo.m3x2.prototype.selfTranslate=function(x,y){return this.c_x+=this.a_x*x+this.b_x*y,this.c_y+=this.a_y*x+this.b_y*y,this},fo.m3x2.prototype.selfRotate=function(c,s){var A_a_x=this.a_x,A_a_y=this.a_y,A_b_x=this.b_x,A_b_y=this.b_y,B_a_x=c,B_a_y=s,B_b_x=-s,B_b_y=c;return this.a_x=A_a_x*B_a_x+A_b_x*B_a_y,this.a_y=A_a_y*B_a_x+A_b_y*B_a_y,this.b_x=A_a_x*B_b_x+A_b_x*B_b_y,this.b_y=A_a_y*B_b_x+A_b_y*B_b_y,this},fo.m3x2.prototype.selfRotateRadians=function(rad){return this.selfRotate(Math.cos(rad),Math.sin(rad))},fo.m3x2.prototype.selfRotateDegrees=function(deg){return this.selfRotateRadians(deg*Math.PI/180)},fo.m3x2.prototype.selfScale=function(x,y){return this.a_x*=x,this.a_y*=x,this.b_x*=y,this.b_y*=y,this},fo.m3x2.prototype.applyVector=function(v,out){var v_x=v.x,v_y=v.y;return out.x=this.a_x*v_x+this.b_x*v_y+this.c_x,out.y=this.a_y*v_x+this.b_y*v_y+this.c_y,out};var setupCanvas=function(scml,canvas,link){var canvas_div=document.getElementById(canvas).appendChild(document.createElement("div"));canvas_div.style.display="inline-block";var canvas_w=jQuery("#"+canvas).width(),canvas_h=jQuery("#"+canvas).height(),camera_x=0,camera_y=0,camera_angle=0,camera_scale=.5,set_camera=function(pose){for(var extent=get_pose_extent(pose),i=0,ict=pose.getNumAnims();ict>i;++i){pose.setAnim(i);for(var k=0,kct=pose.getNumAnimKeys();kct>k;++k)pose.setKey(k),extent=get_pose_extent(pose,extent)}pose.setAnim(0),camera_x=(extent.max.x+extent.min.x)/2,camera_y=(extent.max.y+extent.min.y)/2;var scale_x=canvas_w/(extent.max.x-extent.min.x),scale_y=canvas_h/(extent.max.y-extent.min.y);camera_scale=1/Math.min(scale_x,scale_y),camera_scale*=.9},pose=new spriter.pose,url=scml,data=new spriter.data;data.loadFromURL(url,function(){pose=new spriter.pose(data),set_camera(pose)}),canvas_div.addEventListener("drop",function(e){e.preventDefault();for(var items=e.dataTransfer.items,i=0,ct=items.length;ct>i;++i){var entry=items[i].webkitGetAsEntry();if(entry.isFile){var ext=entry.name.split(".").pop();if("scml"==ext.toLowerCase()){var data=new spriter.data;data.loadFromFileEntry(entry,function(data){return function(){pose=new spriter.pose(data),set_camera(pose)}}(data));break}}}},!1);var cursor_x=0,cursor_y=0,cursor_down=!1,cursor_down_x=0,cursor_down_y=0;canvas_div.addEventListener("mousedown",function(e){cursor_down=!0,cursor_down_x=e.offsetX,cursor_down_y=e.offsetY,pose.setAnim("onclick"),window.location.href=link},!1),canvas_div.addEventListener("mouseup",function(){cursor_down=!1,pose.setAnim("normal")},!1),canvas_div.addEventListener("mouseover",function(){pose.setAnim("hover")},!1),canvas_div.addEventListener("mouseout",function(){pose.setAnim("normal")},!1),canvas_div.addEventListener("mousemove",function(e){cursor_x=e.offsetX,cursor_y=e.offsetY},!1);var canvas_2d=canvas_div.appendChild(document.createElement("canvas"));canvas_2d.width=canvas_w,canvas_2d.height=canvas_h;var view_2d=new fo.view_2d(canvas_2d),time_scale=.15,update=function(tick){var anim_time=tick.elapsed_time*time_scale;pose.update(anim_time)},draw_2d=function(){var ctx_2d=view_2d.ctx_2d;ctx_2d&&(ctx_2d.clearRect(0,0,ctx_2d.canvas.width,ctx_2d.canvas.height),ctx_2d.save(),ctx_2d.translate(ctx_2d.canvas.width/2,ctx_2d.canvas.height/2),ctx_2d.scale(1,-1),ctx_2d.scale(1/camera_scale,1/camera_scale),ctx_2d.rotate(-camera_angle*Math.PI/180),ctx_2d.translate(-camera_x,-camera_y),view_2d.draw_pose_2d(pose),ctx_2d.restore())},tick=new Object;tick.frame=0,tick.time=0,tick.time_last=0,tick.elapsed_time=0;var loop=function(time){window.requestAnimationFrame(loop,null),++tick.frame,tick.time=time,tick.elapsed_time=Math.min(tick.time-tick.time_last,50),update(tick),tick.time_last=time,draw_2d()};loop(tick.time_last)},get_pose_extent=function(pose,extent){extent=extent||{min:{x:1,y:1},max:{x:-1,y:-1}};var bound=function(v){extent.min.x>extent.max.x?(extent.min.x=extent.max.x=v.x,extent.min.y=extent.max.y=v.y):(extent.min.x=Math.min(extent.min.x,v.x),extent.max.x=Math.max(extent.max.x,v.x),extent.min.y=Math.min(extent.min.y,v.y),extent.max.y=Math.max(extent.max.y,v.y))},mtx=new fo.m3x2,ll=new fo.v2(-1,-1),lr=new fo.v2(1,-1),ul=new fo.v2(-1,1),ur=new fo.v2(1,1),tv=new fo.v2(0,0);if(pose.strike(),pose.m_data&&pose.m_data.folder_array)for(var folder_array=pose.m_data.folder_array,object_array=pose.m_tweened_object_array,object_idx=0,object_len=object_array.length;object_len>object_idx;++object_idx){var object=object_array[object_idx],folder=folder_array[object.folder],file=folder.file_array[object.file];mtx.makeIdentity(),mtx.selfTranslate(object.x,object.y),mtx.selfRotateDegrees(object.angle),mtx.selfScale(object.scale_x,object.scale_y);var ex=.5*file.width,ey=.5*file.height;mtx.selfScale(ex,ey);var lpx=2*object.pivot_x-1,lpy=2*object.pivot_y-1;mtx.selfTranslate(-lpx,-lpy),bound(mtx.applyVector(ul,tv)),bound(mtx.applyVector(ur,tv)),bound(mtx.applyVector(lr,tv)),bound(mtx.applyVector(ll,tv))}return extent},fo=fo||{};fo.view_2d=function(canvas_2d){this.ctx_2d=canvas_2d.getContext("2d")},fo.view_2d.prototype.draw_pose_2d=function(pose){var ctx_2d=this.ctx_2d;if(pose.strike(),pose.m_data&&pose.m_data.folder_array)for(var folder_array=pose.m_data.folder_array,object_array=pose.m_tweened_object_array,object_idx=0,object_len=object_array.length;object_len>object_idx;++object_idx){var object=object_array[object_idx],folder=folder_array[object.folder],file=folder.file_array[object.file];ctx_2d.save(),ctx_2d.translate(object.x,object.y),ctx_2d.rotate(object.angle*Math.PI/180),ctx_2d.scale(object.scale_x,object.scale_y);var ex=.5*file.width,ey=.5*file.height,lpx=2*object.pivot_x-1,lpy=2*object.pivot_y-1;ctx_2d.translate(-lpx*ex,-lpy*ey),file.image&&!file.image.hidden?(ctx_2d.scale(1,-1),ctx_2d.globalAlpha=object.a,ctx_2d.drawImage(file.image,-ex,-ey,2*ex,2*ey)):(ctx_2d.fillStyle="rgba(127,127,127,0.5)",ctx_2d.fillRect(-ex,-ey,2*ex,2*ey)),ctx_2d.restore()}},function(){for(var vendors=["ms","Moz","Webkit","O"],i=0;i<vendors.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[vendors[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[vendors[i]+"CancelAnimationFrame"]||window[vendors[i]+"CancelRequestAnimationFrame"];if(!window.requestAnimationFrame){var lastTime=0;window.requestAnimationFrame=function(callback){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);return lastTime=currTime+timeToCall,id}}window.cancelAnimationFrame||(window.cancelAnimationFrame=function(id){window.clearTimeout(id)})}();var spriter=spriter||{};spriter.toBool=function(value,def){return void 0!==value?"true"===value?!0:!1:def||!1},spriter.toInt=function(value,def){return void 0!==value?parseInt(value,10):def||0},spriter.toFloat=function(value,def){return void 0!==value?parseFloat(value):def||0},spriter.toString=function(value,def){return void 0!==value?value:def||""},spriter.toArray=function(value,def){return value?value.length?value:[value]:def||[]},spriter.tween=function(a,b,t){return a+(b-a)*t},spriter.tweenAngle=function(a,b,t,spin){return spin>0&&a>b?a+(b+360-a)*t:0>spin&&b>a?a+(b-360-a)*t:a+(b-a)*t},spriter.combineParent=function(bone,parent_bone){bone.x*=parent_bone.scale_x,bone.y*=parent_bone.scale_y;var rad=parent_bone.angle*Math.PI/180,rc=Math.cos(rad),rs=Math.sin(rad),tx=bone.x,ty=bone.y;bone.x=tx*rc-ty*rs,bone.y=tx*rs+ty*rc,bone.x+=parent_bone.x,bone.y+=parent_bone.y,bone.angle+=parent_bone.angle,bone.scale_x*=parent_bone.scale_x,bone.scale_y*=parent_bone.scale_y},spriter.file=function(){this.id=-1,this.name="",this.width=0,this.height=0},spriter.file.prototype.load=function(json){return this.id=spriter.toInt(json["@id"],-1),this.name=spriter.toString(json["@name"],""),this.width=spriter.toInt(json["@width"],0),this.height=spriter.toInt(json["@height"],0),this},spriter.folder=function(){this.id=-1,this.file_array=null},spriter.folder.prototype.load=function(json){this.id=spriter.toInt(json["@id"],-1),this.file_array=[],json.file=spriter.toArray(json.file);for(var file_idx=0,file_len=json.file.length;file_len>file_idx;++file_idx)this.file_array.push((new spriter.file).load(json.file[file_idx]));return this},spriter.bone=function(){this.id=-1,this.parent=-1,this.x=0,this.y=0,this.angle=0,this.scale_x=1,this.scale_y=1},spriter.bone.prototype.load=function(json){return this.id=spriter.toInt(json["@id"],-1),this.parent=spriter.toInt(json["@parent"],-1),this.x=spriter.toFloat(json["@x"],0),this.y=spriter.toFloat(json["@y"],0),this.angle=spriter.toFloat(json["@angle"],0),this.scale_x=spriter.toFloat(json["@scale_x"],1),this.scale_y=spriter.toFloat(json["@scale_y"],1),this},spriter.bone.prototype.clone=function(other){return(other||new spriter.bone).copy(this)},spriter.bone.prototype.copy=function(other){return this.id=other.id,this.parent=other.parent,this.x=other.x,this.y=other.y,this.angle=other.angle,this.scale_x=other.scale_x,this.scale_y=other.scale_y,this},spriter.bone.prototype.tween=function(other,tween,spin){this.x=spriter.tween(this.x,other.x,tween),this.y=spriter.tween(this.y,other.y,tween),this.angle=spriter.tweenAngle(this.angle,other.angle,tween,spin),this.scale_x=spriter.tween(this.scale_x,other.scale_x,tween),this.scale_y=spriter.tween(this.scale_y,other.scale_y,tween)},spriter.bone_ref=function(){this.id=-1,this.parent=-1,this.timeline=0,this.key=0},spriter.bone_ref.prototype.load=function(json){return this.id=spriter.toInt(json["@id"],-1),this.parent=spriter.toInt(json["@parent"],-1),this.timeline=spriter.toInt(json["@timeline"],0),this.key=spriter.toInt(json["@key"],0),this},spriter.bone_ref.prototype.clone=function(other){return(other||new spriter.bone_ref).copy(this)},spriter.bone_ref.prototype.copy=function(other){return this.id=other.id,this.parent=other.parent,this.timeline=other.timeline,this.key=other.key,this},spriter.object=function(){this.id=-1,this.parent=-1,this.folder=0,this.file=0,this.x=0,this.y=0,this.angle=0,this.scale_x=1,this.scale_y=1,this.pivot_x=0,this.pivot_y=1,this.z_index=0,this.a=1},spriter.object.prototype.load=function(json){return this.id=spriter.toInt(json["@id"],-1),this.parent=spriter.toInt(json["@parent"],-1),this.folder=spriter.toInt(json["@folder"],0),this.file=spriter.toInt(json["@file"],0),this.x=spriter.toFloat(json["@x"],0),this.y=spriter.toFloat(json["@y"],0),this.angle=spriter.toFloat(json["@angle"],0),this.scale_x=spriter.toFloat(json["@scale_x"],1),this.scale_y=spriter.toFloat(json["@scale_y"],1),this.pivot_x=spriter.toFloat(json["@pivot_x"],0),this.pivot_y=spriter.toFloat(json["@pivot_y"],1),this.z_index=spriter.toInt(json["@z_index"],0),this.a=spriter.toFloat(json["@a"],1),this},spriter.object.prototype.clone=function(other){return(other||new spriter.object).copy(this)},spriter.object.prototype.copy=function(other){return this.id=other.id,this.parent=other.parent,this.folder=other.folder,this.file=other.file,this.x=other.x,this.y=other.y,this.angle=other.angle,this.scale_x=other.scale_x,this.scale_y=other.scale_y,this.pivot_x=other.pivot_x,this.pivot_y=other.pivot_y,this.z_index=other.z_index,this.a=other.a,this},spriter.object.prototype.tween=function(other,tween,spin){this.x=spriter.tween(this.x,other.x,tween),this.y=spriter.tween(this.y,other.y,tween),this.angle=spriter.tweenAngle(this.angle,other.angle,tween,spin),this.scale_x=spriter.tween(this.scale_x,other.scale_x,tween),this.scale_y=spriter.tween(this.scale_y,other.scale_y,tween),this.pivot_x=spriter.tween(this.pivot_x,other.pivot_x,tween),this.pivot_y=spriter.tween(this.pivot_y,other.pivot_y,tween),this.a=spriter.tween(this.a,other.a,tween)},spriter.object_ref=function(){this.id=-1,this.parent=-1,this.timeline=0,this.key=0,this.z_index=0},spriter.object_ref.prototype.load=function(json){return this.id=spriter.toInt(json["@id"],-1),this.parent=spriter.toInt(json["@parent"],-1),this.timeline=spriter.toInt(json["@timeline"],0),this.key=spriter.toInt(json["@key"],0),this.z_index=spriter.toInt(json["@z_index"],0),this},spriter.object_ref.prototype.clone=function(other){return(other||new spriter.object_ref).copy(this)},spriter.object_ref.prototype.copy=function(other){return this.id=other.id,this.parent=other.parent,this.timeline=other.timeline,this.key=other.key,this.z_index=other.z_index,this},spriter.mainline_key=function(){this.id=-1,this.time=0,this.bone_array=null,this.object_array=null},spriter.mainline_key.prototype.load=function(json){this.id=spriter.toInt(json["@id"],-1),this.time=spriter.toInt(json["@time"],0),this.bone_array=[],json.bone=spriter.toArray(json.bone);for(var bone_idx=0,bone_len=json.bone.length;bone_len>bone_idx;++bone_idx)this.bone_array.push((new spriter.bone).load(json.bone[bone_idx]));json.bone_ref=spriter.toArray(json.bone_ref);for(var bone_ref_idx=0,bone_ref_len=json.bone_ref.length;bone_ref_len>bone_ref_idx;++bone_ref_idx)this.bone_array.push((new spriter.bone_ref).load(json.bone_ref[bone_ref_idx]));this.bone_array.sort(function(a,b){return a.id-b.id}),this.object_array=[],json.object=spriter.toArray(json.object);for(var object_idx=0,object_len=json.object.length;object_len>object_idx;++object_idx)this.object_array.push((new spriter.object).load(json.object[object_idx]));json.object_ref=spriter.toArray(json.object_ref);for(var object_ref_idx=0,object_ref_len=json.object_ref.length;object_ref_len>object_ref_idx;++object_ref_idx)this.object_array.push((new spriter.object_ref).load(json.object_ref[object_ref_idx]));return this.object_array.sort(function(a,b){return a.id-b.id}),this},spriter.mainline=function(){this.key_array=null},spriter.mainline.prototype.load=function(json){this.key_array=[],json.key=spriter.toArray(json.key);for(var key_idx=0,key_len=json.key.length;key_len>key_idx;++key_idx)this.key_array.push((new spriter.mainline_key).load(json.key[key_idx]));return this},spriter.timeline_key=function(){this.id=-1,this.time=0,this.spin=1,this.bone=null,this.object=null},spriter.timeline_key.prototype.load=function(json){this.id=spriter.toInt(json["@id"],-1),this.time=spriter.toInt(json["@time"],0),this.spin=spriter.toInt(json["@spin"],1);var bone=json.bone;(0===bone||null===bone)&&(bone={}),bone&&(this.bone=(new spriter.bone).load(bone));var object=json.object;return(0===object||null===object)&&(object={}),object&&(this.object=(new spriter.object).load(object)),this},spriter.timeline=function(){this.id=-1,this.name="",this.key_array=null},spriter.timeline.prototype.load=function(json){this.id=spriter.toInt(json["@id"],-1),this.name=spriter.toString(json["@name"],""),this.key_array=[],json.key=spriter.toArray(json.key);for(var key_idx=0,key_len=json.key.length;key_len>key_idx;++key_idx)this.key_array.push((new spriter.timeline_key).load(json.key[key_idx]));return this},spriter.animation=function(){this.id=-1,this.name="",this.length=0,this.looping="true",this.loop_to=0,this.mainline=null,this.timeline_array=null},spriter.animation.prototype.load=function(json){this.id=spriter.toInt(json["@id"],-1),this.name=spriter.toString(json["@name"],""),this.length=spriter.toInt(json["@length"],0),this.looping=spriter.toString(json["@looping"],"true"),this.loop_to=spriter.toInt(json["@loop_to"],0),json.mainline=json.mainline||{},this.mainline=(new spriter.mainline).load(json.mainline),this.timeline_array=[],json.timeline=spriter.toArray(json.timeline);for(var timeline_idx=0,timeline_len=json.timeline.length;timeline_len>timeline_idx;++timeline_idx)this.timeline_array.push((new spriter.timeline).load(json.timeline[timeline_idx]));return this},spriter.entity=function(){this.id=-1,this.name="",this.animation_array=null},spriter.entity.prototype.load=function(json){this.id=spriter.toInt(json["@id"],-1),this.name=spriter.toString(json["@name"],""),this.animation_array=[],json.animation=spriter.toArray(json.animation);for(var animation_idx=0,animation_len=json.animation.length;animation_len>animation_idx;++animation_idx)this.animation_array.push((new spriter.animation).load(json.animation[animation_idx]));return this},spriter.data=function(){this.folder_array=null,this.entity_array=null},spriter.data.prototype.load=function(json){this.folder_array=[],json.folder=spriter.toArray(json.folder);for(var folder_idx=0,folder_len=json.folder.length;folder_len>folder_idx;++folder_idx)this.folder_array.push((new spriter.folder).load(json.folder[folder_idx]));this.entity_array=[],json.entity=spriter.toArray(json.entity);for(var entity_idx=0;entity_idx<json.entity.length;++entity_idx)this.entity_array.push((new spriter.entity).load(json.entity[entity_idx]));return this},spriter.data.prototype.parseSCML=function(scml){var dom_parser=new DOMParser,xml_object=dom_parser.parseFromString(scml,"text/xml"),json_string=xml2json(xml_object,"  "),json=window.JSON.parse(json_string);json.spriter_data&&this.load(json.spriter_data)},spriter.data.prototype.loadFromURL=function(url,callback){var that=this,count=0,inc_count=function(){count++},dec_count=function(){0==--count&&callback()};inc_count();var req=new XMLHttpRequest;if(req.open("GET",url,!0),req.addEventListener("readystatechange",function(){if(4==req.readyState&&(200==req.status||304==req.status)){that.parseSCML(req.responseText);for(var base_path=url.slice(0,url.lastIndexOf("/")),folder_array=that.folder_array,folder_idx=0,folder_len=folder_array.length;folder_len>folder_idx;++folder_idx)for(var folder=folder_array[folder_idx],file_array=folder.file_array,file_idx=0,file_len=file_array.length;file_len>file_idx;++file_idx){var file=file_array[file_idx];inc_count();var image=file.image=new Image;image.hidden=!0,image.addEventListener("load",function(file){return function(e){file.width=file.width||e.target.width,file.height=file.height||e.target.height,e.target.hidden=!1,dec_count()}}(file),!1),image.addEventListener("error",function(){dec_count()},!1),image.addEventListener("abort",function(){dec_count()},!1),image.src=base_path+"/"+file.name}dec_count()}},!1),4!=req.readyState)try{req.send(!1)}catch(e){req.send()}},spriter.data.prototype.loadFromFileList=function(input_file,input_files,callback){var that=this,count=0,inc_count=function(){count++},dec_count=function(){0==--count&&callback()};inc_count();var file_reader=new FileReader;file_reader.addEventListener("load",function(e){that.parseSCML(e.target.result);for(var find_file=function(input_files,texture_name){for(var name=texture_name.toLowerCase()+"$",idx=0,len=input_files.length;len>idx;++idx){var input_file=input_files[idx];input_file.webkitRelativePath=input_file.webkitRelativePath||"";var path=input_file.webkitRelativePath;if(path&&path.toLowerCase().match(name))return input_file}return null},folder_array=that.folder_array,folder_idx=0,folder_len=folder_array.length;folder_len>folder_idx;++folder_idx)for(var folder=folder_array[folder_idx],file_array=folder.file_array,file_idx=0,file_len=file_array.length;file_len>file_idx;++file_idx){var file=file_array[file_idx],texture_file=find_file(input_files,file.name);if(texture_file){inc_count();var texture_file_reader=new FileReader;texture_file_reader.addEventListener("load",function(file){return function(e){var image=file.image=new Image;image.hidden=!0,image.addEventListener("load",function(e){file.width=file.width||e.target.width,file.height=file.height||e.target.height,e.target.hidden=!1,dec_count()},!1),image.addEventListener("error",function(){dec_count()},!1),image.addEventListener("abort",function(){dec_count()},!1),image.src=e.target.result}}(file),!1),texture_file_reader.readAsDataURL(texture_file)}}dec_count()},!1),file_reader.readAsText(input_file)},spriter.data.prototype.loadFromFileEntry=function(entry,callback){var that=this,count=0,inc_count=function(){count++},dec_count=function(){0==--count&&callback()};inc_count(),entry.file(function(file){var reader=new FileReader;reader.addEventListener("load",function(e){that.parseSCML(e.target.result);for(var folder_array=that.folder_array,folder_idx=0,folder_len=folder_array.length;folder_len>folder_idx;++folder_idx)for(var folder=folder_array[folder_idx],file_array=folder.file_array,file_idx=0,file_len=file_array.length;file_len>file_idx;++file_idx){var file=file_array[file_idx];inc_count(),entry.filesystem.root.getFile(file.name,{},function(file){return function(texture_entry){inc_count(),texture_entry.file(function(texture_file){var texture_file_reader=new FileReader;texture_file_reader.addEventListener("load",function(e){var image=file.image=new Image;image.hidden=!0,image.addEventListener("load",function(e){file.width=file.width||e.target.width,file.height=file.height||e.target.height,e.target.hidden=!1,dec_count()},!1),image.addEventListener("error",function(){dec_count()},!1),image.addEventListener("abort",function(){dec_count()},!1),image.src=e.target.result},!1),texture_file_reader.readAsDataURL(texture_file)},function(){dec_count()}),dec_count()}}(file),function(file){return function(e){window.console.log("error code: "+e.code+", could not load texture: "+file.name),dec_count()}}(file))}dec_count()},!1),reader.readAsText(file)})},spriter.data.prototype.getNumEntities=function(){var entity_array=this.entity_array;return entity_array?entity_array.length:0},spriter.data.prototype.getEntityName=function(entity_index){var entity_array=this.entity_array;if(entity_array&&entity_index<entity_array.length){var entity=entity_array[entity_index];return entity.name}return""},spriter.data.prototype.getNumAnims=function(entity_index){var entity_array=this.entity_array;if(entity_array&&entity_index<entity_array.length){var entity=entity_array[entity_index],animation_array=entity.animation_array;if(animation_array)return animation_array.length}return 0},spriter.data.prototype.getAnimName=function(entity_index,anim_index){var entity_array=this.entity_array;if(entity_array&&entity_index<entity_array.length){var entity=entity_array[entity_index],animation_array=entity.animation_array;if(animation_array&&anim_index<animation_array.length){var anim=animation_array[anim_index];return anim.name}}return""},spriter.data.prototype.getAnimLength=function(entity_index,anim_index){var entity_array=this.entity_array;if(entity_array&&entity_index<entity_array.length){var entity=entity_array[entity_index],animation_array=entity.animation_array;if(animation_array&&anim_index<animation_array.length){var anim=animation_array[anim_index];return anim.length}}return-1},spriter.data.prototype.getNumAnimKeys=function(entity_index,anim_index){var entity_array=this.entity_array;if(entity_array&&entity_index<entity_array.length){var entity=entity_array[entity_index],animation_array=entity.animation_array;if(animation_array&&anim_index<animation_array.length){var anim=animation_array[anim_index];return anim.mainline.key_array.length}}return 0},spriter.data.prototype.getAnimKeyTime=function(entity_index,anim_index,key_index){var entity_array=this.entity_array;if(entity_array&&entity_index<entity_array.length){var entity=entity_array[entity_index],animation_array=entity.animation_array;if(animation_array&&anim_index<animation_array.length){var anim=animation_array[anim_index],key_array=anim.mainline.key_array;if(key_array&&key_index<key_array.length)return key_array[key_index].time}}return 0},spriter.pose=function(data){this.m_data=data||null,this.m_entity_index=0,this.m_anim_index=0,this.m_time=0,this.m_dirty=!0,this.m_mainline_key_index=0,this.m_tweened_bone_array=[],this.m_tweened_object_array=[]},spriter.pose.prototype.getNumEntities=function(){return this.m_data?this.m_data.getNumEntities():0},spriter.pose.prototype.getEntity=function(){return this.m_entity_index},spriter.pose.prototype.setEntity=function(entity_id){var num_entities=this.getNumEntities();if(isFinite(entity_id))num_entities>entity_id&&(this.m_entity_index=entity_id,this.m_anim_index=0,this.m_time=0,this.m_dirty=!0);else for(var entity_idx=0;num_entities>entity_idx;++entity_idx)if(entity_id==this.getEntityName(entity_idx)){this.m_entity_index=entity_idx,this.m_anim_index=0,this.m_time=0,this.m_dirty=!0;break}},spriter.pose.prototype.getEntityName=function(entity_index){return entity_index=void 0!==entity_index?entity_index:this.m_entity_index,this.m_data?this.m_data.getEntityName(entity_index):""},spriter.pose.prototype.getNumAnims=function(entity_index){return entity_index=void 0!==entity_index?entity_index:this.m_entity_index,this.m_data?this.m_data.getNumAnims(entity_index):0},spriter.pose.prototype.getAnim=function(){return this.m_anim_index},spriter.pose.prototype.setAnim=function(anim_id){if(isFinite(anim_id))anim_id>=0&&anim_id<this.getNumAnims()&&(this.m_anim_index=anim_id,this.m_time=0,this.m_dirty=!0);else for(var anim_idx=0,anim_len=this.getNumAnims();anim_len>anim_idx;++anim_idx)if(anim_id==this.getAnimName(anim_idx)){this.m_anim_index=anim_idx,this.m_time=0,this.m_dirty=!0;break}},spriter.pose.prototype.setNextAnim=function(){var num_anims=this.getNumAnims();num_anims>1&&this.setAnim((this.getAnim()+1)%num_anims)},spriter.pose.prototype.setPrevAnim=function(){var num_anims=this.getNumAnims();num_anims>1&&this.setAnim((this.getAnim()+num_anims-1)%num_anims)},spriter.pose.prototype.getAnimName=function(anim_index){var entity_index=this.m_entity_index;return anim_index=void 0!==anim_index?anim_index:this.m_anim_index,this.m_data?this.m_data.getAnimName(entity_index,anim_index):""},spriter.pose.prototype.getAnimLength=function(anim_index){var entity_index=this.m_entity_index;return anim_index=void 0!==anim_index?anim_index:this.m_anim_index,this.m_data?this.m_data.getAnimLength(entity_index,anim_index):-1},spriter.pose.prototype.getNumAnimKeys=function(anim_index){var entity_index=this.m_entity_index;return anim_index=void 0!==anim_index?anim_index:this.m_anim_index,this.m_data?this.m_data.getNumAnimKeys(entity_index,anim_index):0},spriter.pose.prototype.getAnimKeyTime=function(anim_index,key_index){var entity_index=this.m_entity_index;return anim_index=void 0!==anim_index?anim_index:this.m_anim_index,this.m_data?this.m_data.getAnimKeyTime(entity_index,anim_index,key_index):0},spriter.pose.prototype.getNumAnimKeys=function(anim_index){var entity_index=this.m_entity_index;return anim_index=void 0!==anim_index?anim_index:this.m_anim_index,this.m_data?this.m_data.getNumAnimKeys(entity_index,anim_index):0},spriter.pose.prototype.getAnimKeyTime=function(anim_index,key_index){var entity_index=this.m_entity_index;return anim_index=void 0!==anim_index?anim_index:this.m_anim_index,key_index=void 0!==key_index?key_index:this.m_mainline_key_index,this.m_data?this.m_data.getAnimKeyTime(entity_index,anim_index,key_index):0},spriter.pose.prototype.getTime=function(){return this.m_time},spriter.pose.prototype.setTime=function(time){this.m_time!=time&&(this.m_time=time,this.m_dirty=!0)},spriter.pose.prototype.getKey=function(){return this.m_mainline_key_index},spriter.pose.prototype.setKey=function(key_index){this.m_mainline_key_index!=key_index&&(this.m_time=this.getAnimKeyTime(this.m_anim_index,key_index),this.m_dirty=!0)},spriter.pose.prototype.update=function(elapsed_time){var anim_length=this.getAnimLength();if(anim_length>0){for(this.m_time+=elapsed_time;this.m_time<0;)this.m_time+=anim_length;for(;this.m_time>=anim_length;)this.m_time-=anim_length;this.m_dirty=!0}},spriter.pose.prototype.strike=function(){if(this.m_dirty&&(this.m_dirty=!1,this.m_data&&this.m_data.entity_array)){for(var entity_array=this.m_data.entity_array,entity=entity_array[this.m_entity_index],animation_array=entity.animation_array,animation=animation_array[this.m_anim_index],mainline=animation.mainline,mainline_key_array=mainline.key_array,tween_time=this.m_time,mainline_key_index=0;mainline_key_index<mainline_key_array.length;++mainline_key_index){var mainline_key=mainline_key_array[mainline_key_index];if(tween_time<mainline_key.time)break}mainline_key_index>0&&mainline_key_index--,this.m_mainline_key_index=mainline_key_index;for(var mainline_key=mainline_key_array[this.m_mainline_key_index],timeline_array=animation.timeline_array,bone_array=mainline_key.bone_array,tweened_bone_array=this.m_tweened_bone_array,bone_idx=0,bone_len=bone_array.length;bone_len>bone_idx;++bone_idx){var tweened_bone=tweened_bone_array[bone_idx]=tweened_bone_array[bone_idx]||new spriter.bone,bone=bone_array[bone_idx],timeline_index=bone.timeline;
if(void 0!==timeline_index){var key_index=bone.key,timeline=timeline_array[timeline_index],timeline_key_array=timeline.key_array,timeline_key=timeline_key_array[key_index],time1=timeline_key.time,bone1=timeline_key.bone;tweened_bone.copy(bone1),tweened_bone.parent=bone.parent;var timeline_key2=timeline_key_array[key_index+1];if(void 0!==timeline_key2){var time2=timeline_key2.time,bone2=timeline_key2.bone,tween=(tween_time-time1)/(time2-time1);tweened_bone.tween(bone2,tween,timeline_key.spin)}}else bone=bone,tweened_bone.copy(bone);var parent_index=bone.parent;parent_index>=0&&spriter.combineParent(tweened_bone,tweened_bone_array[parent_index])}tweened_bone_array.length>bone_array.length&&(tweened_bone_array.length=bone_array.length);for(var object_array=mainline_key.object_array,tweened_object_array=this.m_tweened_object_array,object_idx=0,object_len=object_array.length;object_len>object_idx;++object_idx){var tweened_object=tweened_object_array[object_idx]=tweened_object_array[object_idx]||new spriter.object,object=object_array[object_idx],timeline_index=object.timeline;if(void 0!==timeline_index){var key_index=object.key,timeline=timeline_array[timeline_index],timeline_key_array=timeline.key_array,timeline_key=timeline_key_array[key_index],time1=timeline_key.time,object1=timeline_key.object;tweened_object.copy(object1),tweened_object.parent=object.parent;var timeline_key2=timeline_key_array[key_index+1];if(void 0!==timeline_key2){var time2=timeline_key2.time,object2=timeline_key2.object,tween=(tween_time-time1)/(time2-time1);tweened_object.tween(object2,tween,timeline_key.spin)}}else object=object,tweened_object.copy(object);var parent_index=object.parent;parent_index>=0&&spriter.combineParent(tweened_object,tweened_bone_array[parent_index])}tweened_object_array.length>object_array.length&&(tweened_object_array.length=object_array.length)}};